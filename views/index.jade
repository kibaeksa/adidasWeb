doctype
html(lang='en')
    head
        meta(charset='utf-8')
        title 코딩리스트
        link(rel='stylesheet' type='text/css' href='http://image.adidas.co.kr/css/adidas/adidas_r.css')
        style(type='text/css').
            @import url(//fonts.googleapis.com/earlyaccess/notosanskr.css);
            html , body{
                width: 100%;
                height: 100%;
            }

            .wrapper{
                width: 100%;
            }

            .utilbox{
                width: 100%;
                text-align: center;
                position: absolute;
                top: 0;
                left: 0;
                background:rgba(255,255,255,0.9);
            }

            .utilbox.fixed{
                box-shadow: 0 0 15px rgba(0,0,0,0.56)
            }

            .utilbox .button_area{
                padding: 0 10px 10px;
                text-align: center;
            }
            
            .utilbox.fixed .button_area{
            }

            .button_area .btn-ctm{
                height:auto;
                padding:13px 15px;
                margin: 0 5px;
                display: inline-block;
            }
            
            .utilbox.fixed .search_area{
                padding:10px;
            }
            
            .utilbox.fixed .search_area::before{
                top: 11px;
                left: 13px;
            }
            
            .utilbox.fixed .button_area{
                text-align:right;
            }
            
            .utilbox.fixed .button_area .btn-ctm{
                padding:8px 10px;
            }

            .button_area .btn-ctm span{
                font-size: 12px;
                line-height:12px;
            }

            .btn-ctm.disable{
                background: #ddd;
                cursor: default;
            }

            .search_area{
                position:relative;
                padding: 15px;
            }
            
            .search_area::before{
                content:'';
                display:block;
                width: 28px;
                height: 32px;
                position: absolute;
                top: 16px;
                left: 20px;
                background:url('/images/adidas/common/adidas_spirite.png') -110px -1250px;
            }

            .search_area input{
                width: 100%;
                height: 35px;
                padding-left: 35px;
                font: 500 13px/35px 'NotoSansKR';
                color: #000;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }

            .wrapper .title{
                padding: 15px 0;
                text-align: center;
                background: #ccc;
                font:700 13px 'Noto Sans KR';
            }

            .wrapper .col_box{
                padding:10px;
                border-bottom: 1px dashed  #ddd;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }

            .wrapper .col_box.dir_col{
                padding: 5px 10px;
                border-bottom:1px solid #ddd;
                background: #eee;
            }

            .wrapper .col_box:last-child{
                border-bottom-width: 0;
            }

            .wrapper .col_box ul{
                /*display: -webkit-flex;
                display: -ms-flex;
                display: flex;*/
                /*padding: 10px;*/

            }

            .wrapper .col_box ul li{
                /*padding: 10px 0;*/
            }

            .wrapper .col_box ul li.name{
                min-height: 25px;
                background:url('/data/ico-html.gif') 0 3px no-repeat;
                -webkit-background-size: 10px auto;
                background-size: 10px auto;
                padding: 0 0 0 19px;
                font:500 12px 'Noto Sans KR';
            }

            .wrapper .col_box ul li.name.dir{
                background:url('/data/ico-folder.png') 0 5px no-repeat;
                -webkit-background-size: 14px auto;
                background-size: 14px auto;
            }

            .wrapper .col_box ul li.name a{
                color: #1313af;
            }

            .wrapper .col_box ul li.name a:hover{
                text-decoration: underline;
            }

            .wrapper .col_box ul li.desc{
                width: 100%;
                font:700 12px/17px 'Noto Sans KR';
                color: #222;
            }

            .wrapper .col_box ul li.modify{
                height: 0;
                margin-top: 10px;
                overflow: hidden;
                transition: height 0.2s;
                -webkit-transition: height 0.2s;
            }

            .edit-mode .wrapper .col_box ul li.modify{
                height: 35px;
            }

            .wrapper .col_box ul li.modify input{
                width: 100%;
                height: 35px;
                padding-left: 10px;
                font:500 13px 'NotoSansKR';
                color: #000;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }

            #wrapper{
                width: 100%;
                height: 100%;
                position: relative;
                overflow: hidden;
            }

            #wrapper #left-area{
                width: 360px;
                height: 100%;
                padding-top: 125px;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 100;
                overflow: auto;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }

            #wrapper #right-area{
                width: 100%;
                height: 100%;
                position: relative;
                padding-left: 360px;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }

            #wrapper #right-area .inner{
                width: 100%;
                height: 100%;
                position: relative;
                border-left: 1px solid  #ddd;
            }

            #wrapper #right-area .inner iframe{
                width: 100%;
                height: 100%;
                border-width: 0;
            }

            #dragHandle{
                width: 10px;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1000;
                cursor: w-resize;
            }

            #dragHandleCover{
                width: 100%;
                height: 100%;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 999;
            }
            
            .wrapper .search_result .col_box{
            
            }
            
            .wrapper .search_result .search_title{
                color: #333;
                font: 16px 'NotoSansKR';
                text-align: center;
                padding: 10px 0;
            }
            
            .wrapper .search_result .col_box .keyword{
                background:yellow;
                font-weight:bold;
            }
            
            

        script(type='text/javascript' src='http://image.reebok.co.kr/js/jquery/jquery-1.4.2.js')


    body
        input#brand(type='hidden' value='#{brand}')
        div#wrapper
            div#left-area
                div.wrapper
                    div.utilbox
                        div.search_area
                            input#search-html(type='text' placeholder="검색은 파일명,파일설명만 찾아냅니다. 양해바람.")
                        div.button_area
                            a#toggle-mode.btn-ctm(href='javascript:void(0)')
                                span EDIT MODE
                            a#submit-data.btn-ctm.disable(href='javascript:void(0)')
                                span 저장하기
                    div#coding-list
                    
                    
            div#right-area
                div.inner
                    div#dragHandle
                    iframe#content-iframe(width='100%' height='100%')
                    
                    
                    
            script(type='text/javascript').
                let brandName = $('input#brand').val();
                let depth = 1;
                let curCategory = 'root';
                const absPath = '/html/'+brandName+'/';
                let htmlData = {};
                
                const getDataForRender = key => {
                    let newData = getObjChildDirectory(key);
                    newData.push(htmlData[key]);
                    return newData;
                }
                
                const getObjChildDirectory = path => {
                    var key,
                        newObj = [],
                        i = 0,
                        count = 0;
                
                    for(key in htmlData){
                        const objPath = key.split('___');
                        const targetPath = typeof path === 'string' ? path.split('___') : path;
                
                        if(key === targetPath.join('___')){
                            continue;
                        }
                
                        /* 바로 밑에 폴더만 찾는다. */
                        if(htmlData[key].depth - 1 ==  targetPath.length){
                            /* Reassign i as 0 */
                            i = 0;
                
                            for(; i < targetPath.length; i++){
                                if(objPath[i] == targetPath[i]){
                                    count++;
                                }else{
                                    count = 0;
                                    continue;
                                }
                
                                if(count == targetPath.length){
                
                                    newObj.push(key);
                                    count = 0 ;
                                    continue;
                                }
                            }
                        }
                    }
                
                
                    return newObj;
                
                };
                
                const setHash = event =>{
                    let hash = location.hash.replace(/#/,'');
                    
                    console.log(hash);
                    
                    if(hash == ''){
                        hash = 'root';
                    }
                    
                    const hasObj = getBooleanByKey(hash);
                    console.log(hasObj)
                    //- console.log(hasObj);
                    
                    if(hasObj){
                        renderHTML(getDataForRender(hash));
                    }else{
                        renderHTML(false);
                    }
                };
                
                
                const getBooleanByKey = key =>{
                    for(obj in htmlData){
                        if(key == obj){
                            return true;
                        }
                    }
                    
                    return false;
                };
                
                window.addEventListener('hashchange',setHash);
                
                const changeContets = htmlPath => {
                    document.getElementById('content-iframe').setAttribute('src',htmlPath);
                };
                
                const handleData = obj => {
                    for(let key in obj){
                        const splitKey = key.replace(/root/,'/').split('___');
                        obj[key].depth = splitKey.length;
                        splitKey.splice(splitKey.length-1);
                        obj[key].parentDir = splitKey;
                    }
                
                    return obj;
                };
                
                const submitInfo = () => {
                    var data = {
                        htmlList : htmlData,
                        targetPath : '/app/data/codingList/'+brandName+'/',
                        brand : brandName
                    };
                    
                    //- console.log(htmlData)
                
                    $.ajax({
                        type: 'POST',
                        url: '/modifyHtmlJson',
                        data: data,
                        beforeSend : function(){
                            $('body').append('<div id="loading" style="width:100%;height:100%;position:absolute;top:0;left:0;z-index:100;background:rgba(255,255,255,0.7)"><span style="position:absolute;top:50%;left:50%;width:100px;height:30px;font-size:12px;line-height:30px;margin:-15px 0 0 -50px;text-align:center;">Loading...</span></div>')
                        },
                        success:function(result){
                            $('#loading').remove();
                            renderHTML(getDataForRender(curCategory));
                        },
                        error:function(e){
                            $('#loading').remove();
                            $('#wrapper').removeClass('edit-mode');
                            //- renderHTML(getDataForRender(curCategory));
                            setHash();
                            console.log(e.responseText);
                        },
                        dataType : 'json',
                    });
                
                    return false;
                };
                
                const bindEvent = () => {
                    var inputArray = [...document.querySelectorAll('.col_box input[type="text"]')];
                    var dirArray = [...document.querySelectorAll('.name.dir>a')];
                
                    inputArray.map(value => {
                        value.addEventListener('keyup',event =>{
                            var elem = event.currentTarget;
                            var key = elem.dataset.key;
                            var index = elem.dataset.index;
                        
                            if(elem.dataset.isdir == 'true'){                                
                                htmlData[key].desc = event.target.value.replace(/"/,'\"');
                            }else{
                                htmlData[key]['htmlData'][index].desc = event.target.value.replace(/"/,'\"');
                            }
                            
                        });
                    });
                
                    dirArray.map(value => {
                        value.addEventListener('click',event =>{
                            curCategory = event.currentTarget.dataset.dir;
                            location.hash = event.currentTarget.dataset.dir;                            
                        });
                    });
                
                    $('#toggle-mode').bind('click',function(){
                        if($(this).hasClass('edit')){
                            $(this).removeClass('edit');
                            $('#submit-data').addClass('disable');
                            $('#wrapper').removeClass('edit-mode');
                            $(this).find('span').text('EDIT MODE');
                        }else{
                            $(this).addClass('edit');
                            $('#submit-data').removeClass('disable');
                            $('#wrapper').addClass('edit-mode');
                            $(this).find('span').text('VIEW MODE');
                        }
                    });
                
                    $('#submit-data').bind('click',function(){
                        if($(this).hasClass('disable')){
                            return;
                        }
                        submitInfo();
                    });
                
                
                }
                
                const renderHTML = data => {
                    if(!data){
                        document.getElementById('coding-list').innerHTML = `
                            <div class="nodata" style="text-align: center;font: 700 16px 'NotoSansKR';color: #000;">데이터가 없습니다.</div>
                        `;
                        $('.utilbox').addClass('fixed');
                        return false;
                    }
                    
                    let htmlString = `<div class="title">${data[data.length-1].path}</div>`;
                
                    if(data[data.length-1].depth > 1){
                        const parentPath = (() =>{
                            let path = '';
                            data[data.length-1].parentDir.map((data , index) => {
                                if(index == 0){
                                    path += 'root';
                                }else{
                                    path += '___'+data;
                                }
                            });
                
                            return path;
                        })();
                
                        // console.log(parentPath);
                
                        htmlString += `
                            <div class="col_box dir_col">
                                <ul>
                                    <li class="name dir"><a href="javascript:void(0)" data-dir="${parentPath}" title="">...</a></li>
                                </ul>
                            </div>
                        `;
                    }
                
                    data.map( renderData => {
                
                        const keyName = typeof renderData === 'string' ? renderData.replace(/^root___/,'/').replace(/___/g,'/') : renderData.path;
                
                        if(typeof renderData === 'string'){
                            //- console.log(htmlData[renderData]);
                            //- console.log(htmlData);
                            htmlString += `
                                <div class="col_box dir_col">
                                    <ul>
                                        <li class="name dir"><a href="javascript:void(0)" data-dir="${renderData}" title="${keyName}">${keyName}</a></li>
                                        <li class="desc">${htmlData[renderData].desc ? htmlData[renderData].desc : ''}</li>
                                        <li class="modify"><input type="text" id="${renderData}" value="${htmlData[renderData].desc ? htmlData[renderData].desc : ''}" data-key="${renderData}" data-isdir="true"></li>
                                    </ul>
                                </div>
                            `;
                        }else{
                            renderData['htmlData'].map((value , index) => {
                                const key = renderData.path.replace(/^\/$/,'root').replace(/^\//,'root___').replace(/\//,'___');
                                htmlString += `
                                    <div class="col_box">
                                        <ul>
                                            <li class="name"><a href="javascript:void(0)" onclick="changeContets('${absPath + keyName.replace(/root_/,'/') +'/'+ value.name }')">${value.name}</a></li>
                                            <li class="desc">${value.desc ? value.desc : ''}</li>
                                            <li class="modify"><input type="text" id="${key+'___'+value.name.replace(/\.html/,'')}" value="${value.desc ? value.desc : ''}" data-key="${key.replace(/___$/,'').replace(/\/$/,'')}" data-index="${index}"></li>
                                        </ul>
                                    </div>
                                `
                            });
                        }
                
                
                    })
                
                    htmlString += `</div>`;
                    document.getElementById('coding-list').innerHTML = htmlString;
                    bindEvent();
                };
                
                
                const renderSearch = data => {                    
                    let key;
                    let htmlString = `
                        <div class="search_result">
                            <div class="search_title">검색결과 입니다.</div>
                    `;
                    const absPath = '/html/'+brandName+'/';
                    
                    for(key in data){
                        if(key == 'length'){
                            continue;
                        }
                        
                        //- htmlString += `    <div class="title">${ key.replace(/^root$/g,'/').replace(/^root___/g,'/').replace(/___/,'/') }</div>`;
                        htmlString += `    <div class="title">${ key.replace(/^root$/g,'/').replace(/^root___/g,'/').replace(/___/,'/') }</div>`;
                        data[key].htmlData.map((htmlObj , index) => {
                        htmlString += `
                            <div class="col_box">
                                <ul>
                                    <li class="name">
                                        <a href="javascript:void(0)" onclick="changeContets('${absPath + key.replace(/^root$/g,'/').replace(/^root___/g,'/').replace(/___/,'/') + htmlObj.originName }')">${htmlObj.name}</a>
                                    </li>
                                    <li class="desc">${htmlObj.desc ? htmlObj.desc : ''}</li>
                                    <li class="modify">
                                        <input type="text" id="${key+'___'+htmlObj.originName.replace(/\.html/,'')}" value="${htmlObj.desc ? htmlObj.desc : ''}" data-key="${key.replace(/___$/,'').replace(/\/$/,'')}" data-index="${index}">
                                    </li>
                                </ul>
                            </div>
                        `
                        });                        
                    }
                    htmlString += '</div>';
            
                    document.getElementById('coding-list').innerHTML = htmlString;
                    $('.utilbox').addClass('fixed');
                }
                
                const startDragGrid = event => {
                    event.preventDefault();
                    const dummyDiv = document.createElement('div');
                    dummyDiv.setAttribute('id','dragHandleCover');
                    window.addEventListener('mousemove',moveDragGrid);
                    window.addEventListener('mouseup',endDragGrid);
                    document.querySelector('body').appendChild(dummyDiv);
                };
                
                const moveDragGrid = event => {
                    event.preventDefault();
                
                    const minX = 200;
                    const maxX = 800;
                    const x = event.pageX;
                
                    if(x > minX && x < maxX){
                        document.getElementById('left-area').style.width = x+'px';
                        document.getElementById('right-area').style.paddingLeft = x+'px';
                    }
                };
                
                const endDragGrid = event => {
                    event.preventDefault();
                    const dummyDiv = document.getElementById('dragHandleCover');
                    document.querySelector('body').removeChild(dummyDiv);
                
                    window.removeEventListener('mousemove',moveDragGrid);
                    window.removeEventListener('mouseup',endDragGrid);
                };
                
                document.getElementById('dragHandle').addEventListener('mousedown',startDragGrid);
                
                $.ajax({
                   url: '/data/codingList/'+brandName+'/codingListInfo.json',
                   dataType : 'json',
                   beforeSend : function(){
                       $('body').append('<di v id="loading" style="width:100%;height:100%;position:absolute;top:0;left:0;z-index:100;background:rgba(255,255,255,0.7)"><span style="position:absolute;top:50%;left:50%;width:100px;height:30px;font-size:12px;line-height:30px;margin:-15px 0 0 -50px;text-align:center;">Loading...</span></div>')
                   },
                   success:function(result){
                        $('#loading').remove();
                        htmlData = handleData(result);
                        console.log(htmlData);
                        setHash();
                   },
                   error:function(e){
                       $('#wrap').html('<div class="nodata">데이터를 로드 할 수 없습니다.</div>');
                       $('#loading').remove();
                   }
                });
    
                $('#left-area').bind('scroll',function(event){
                    var triggerPoint = $(this).find('.wrapper .title').offset().top;
                    var defaultVal = 125;
               
                    if($(this).scrollTop() > 125){
                        $(this).find('.utilbox').addClass('fixed').css({
                            top : $(this).scrollTop()
                        })
                    }else{
                        $(this).find('.utilbox').removeClass('fixed').css({
                            top : 0 
                        })
                    }
                });
                
                const searchModule = {
                    init (keyword){
                        var allData = htmlData;
                        var resultArray = [];

                        const searchInit = keyword => {
                            var findCtgrLength = 2;
                            var newArray = [];
                            var i = 0;
                            var count = 0;
                            var path;

                            if(keyword == ''){
                                
                                setTimeout(() => {
                                    setHash();
                                },200)
                            
                            }else{
                                for(key in htmlData){
                                    path = htmlData[key].path;
                                    
                                    //- var newKey = key.replace(/^root$/g,'/').replace(/^root___/g,'/').replace(/___/,'/');
                                    //- var pkgNameKeyword = searchKeyword(newKey,keyword);
                                    //- 
                                    //- if(pkgNameKeyword){
                                    //-     newArray.push({
                                    //-         type : 'package',
                                    //-         originName : key,
                                    //-         name :pkgNameKeyword,
                                    //-         path : path,
                                    //-         desc : htmlData[key].desc == undefined ? '' : htmlData[key].desc
                                    //-         
                                    //-     });
                                    //- }
                                    
                                    for(var i = 0; i < htmlData[key].htmlData.length; i++){
                                        var nameKeyword = searchKeyword(htmlData[key].htmlData[i].name,keyword);
                                        var descKeyword = htmlData[key].htmlData[i].desc == undefined ? false : searchKeyword(htmlData[key].htmlData[i].desc,keyword);
                                        console.log(descKeyword);
                                        
                                        if(nameKeyword || descKeyword){
                                            console.log(descKeyword);
                                            newArray.push({
                                                originName : htmlData[key].htmlData[i].name,
                                                name :!nameKeyword ? htmlData[key].htmlData[i].name : nameKeyword,
                                                path : path,
                                                desc : !!descKeyword ? descKeyword : htmlData[key].htmlData[i].desc
                                                
                                            });
                                            
                                            console.log('in Array : ',newArray[newArray.length-1].desc);

                                        }
                                        
                                    }
                                }
                            }
                            
                            return refactoringDataForSearch(newArray);
                        }
                        /* searchInit function END */

                        const searchKeyword = (targetStr , keywordStr) => {
                            var keywordArray = keywordStr.split('');
                            var targetArray = targetStr.split('');
                            var index = 0;
                            var length = keywordArray.length;
                            var counter = 0;
                            var resultIndexArray = [];

                            for(; index < targetArray.length; index++){
                                if(targetArray[index].toLowerCase() == keywordArray[counter].toLowerCase()){
                                    counter += 1;
                                    resultIndexArray.push(index);

                                    if(counter == length){
                                        if(keywordStr.length > 1){
                                            targetArray[resultIndexArray[0]] = '<span class="keyword">'+targetArray[resultIndexArray[0]];
                                            targetArray[resultIndexArray[resultIndexArray.length-1]] = targetArray[resultIndexArray[resultIndexArray.length-1]]+'</span>';
                                        }else{
                                            targetArray[resultIndexArray[0]] = '<span class="keyword">'+targetArray[resultIndexArray[0]]+'</span>';
                                        }

                                        return targetArray.join('');
                                    }
                                }else{
                                    counter = 0;
                                    resultIndexArray = [];
                                }
                            }

                            return false;
                        }
                        /* searchKeyword function END */
                        
                        
                        const refactoringDataForSearch = arr =>{
                            if(arr.length == 0){
                                return [];
                            }
                        
                            var i = 0;
                            var newObj = {
                                length : arr.length
                            };
                            
                            for(i; i < arr.length; i++){
                            
                                var ctgrKey = arr[i].path.replace(/^\/$/,'root').replace(/\/$/,'').replace(/^\//g,'root___').replace(/\//g,'___');                                
                                                          
                                if(!newObj[ctgrKey]){
                                    newObj[ctgrKey] = {
                                        path : ctgrKey.replace(/^root___/g,'/').replace(/___/g,'/')+'/',
                                        htmlData : []
                                    };                                    
                                }
                                
                                newObj[ctgrKey].htmlData.push(arr[i]);
                                
                            }
                            
                            console.log(newObj);
                            
                            return newObj;
                        }
                        /* refactoringDataForSearch function END */

                        var newArr = searchInit(keyword);

                        if(newArr.length > 0){
                            renderSearch(newArr);
                        }else{
                            $('.utilbox').addClass('fixed');
                            document.getElementById('coding-list').innerHTML = `
                                <div class="nodata" style="text-align: center;font: 700 16px 'NotoSansKR';color: #000;">검색 결과가 없습니다.</div>
                            `;
                        }
                    },
                    timer : '',
                    bindEvent(event){
                        console.log(this);
                        var init = this.init;
                        var keyword = $(event.currentTarget).val();
                        this.keyword = $(event.currentTarget).val();
                        clearTimeout(this.timer);
                        this.timer = setTimeout(function(){
                            init(keyword);
                        },200);
                    }
                };
                            
            
                document.getElementById('search-html').addEventListener('keyup' , event =>{
                    searchModule.bindEvent(event)
                })

var DB,subscriptionId=!1,FCM_ENDPOINT="https://fcm.googleapis.com/fcm/send/",FF_ENDPOINT="https://updates.push.services.mozilla.com/push/v1/",COLLECTOR_API_ENDPOINT="https://collector.api.useinsider.com/store",LOG_API_ENDPOINT="https://log.api.useinsider.com/v1/collect",NOTIFICATION_CLICK_ACTION_CODE=2,NOTIFICATION_CLOSE_ACTION_CODE=3,NOTIFICATION_DELIVER_ACTION_CODE=4,partnerName=!1,WorkerMessengerCommand={AMP_SUBSCRIPTION_STATE:"amp-web-push-subscription-state",AMP_SUBSCRIBE:"amp-web-push-subscribe",AMP_UNSUBSCRIBE:"amp-web-push-unsubscribe"};function onMessageReceivedSubscriptionState(){var t=null;self.registration.pushManager.getSubscription().then(function(e){return t=e,e?self.registration.pushManager.permissionState(e.options):null}).then(function(e){if(null===e)broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,!1);else{var i=Boolean(t)&&"granted"===e;broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE,i)}})}function onMessageReceivedSubscribe(){self.registration.pushManager.subscribe({userVisibleOnly:!0}).then(function(){broadcastReply(WorkerMessengerCommand.AMP_SUBSCRIBE,null)})}function onMessageReceivedUnsubscribe(){self.registration.pushManager.getSubscription().then(function(t){t.unsubscribe()}).then(function(){broadcastReply(WorkerMessengerCommand.AMP_UNSUBSCRIBE,null)})}function broadcastReply(t,e){self.clients.matchAll().then(function(i){for(var n=0;n<i.length;n++){i[n].postMessage({command:t,payload:e})}})}function PushWorker(){this.spUID=null;var t=this;this.initialize=function(){this.setDefaultSettings(),self.addEventListener("push",this.pushHandler.bind(this)),self.addEventListener("notificationclick",this.notificationClickListener.bind(this)),self.addEventListener("notificationclose",this.notificationCloseHandler.bind(this)),self.addEventListener("install",function(t){return t.waitUntil(self.skipWaiting())}),self.addEventListener("activate",function(t){return t.waitUntil(self.clients.claim())})},this.setDefaultSettings=function(){this.openIndexedDB("INSIDER_WEB_PUSH_DB").then(function(t){return this.getSettings(t)}.bind(this)).then(function(t){this.spUID=t.spUID}.bind(this))},this.pushHandler=function(t){t.waitUntil(this.openIndexedDB("INSIDER_WEB_PUSH_DB").then(function(t){return this.getSettings(t)}.bind(this)).then(function(e){return this.getNotification(e,t)}.bind(this)).then(function(t){return this.displayNotification(t)}.bind(this)))},this.putLastPushDataToDB=function(t){this.openIndexedDB("INSIDER_WEB_PUSH_DB").then(function(e){this.updateSettingsByName(e,"lastReceivedWebPushes",t)}.bind(this))},this.getSubscriptionId=function(t){var e=t.endpoint;return 0===e.indexOf(FF_ENDPOINT)?e.replace(FF_ENDPOINT,""):0===e.indexOf(FCM_ENDPOINT)?e.replace(FCM_ENDPOINT,""):t.subscriptionId},this.setSubscriptionId=function(t){return subscriptionId=this.getSubscriptionId(t)},this.fetchNotification=function(t){var e=[],i={title:"",options:{}};if(t.data){var n=JSON.parse(JSON.stringify(t.data.json()));return i.title=n.title,i.options={body:n.description,icon:n.image,image:n.banner,actions:n.actions,requireInteraction:"0"!==n.requireInteraction,tag:n.campId,data:{url:n.link,actions:n.actions}},e.push(i),this.sendLog(this.getWebPushImpressionLogParameters(n)),e}return this.showErrorNotification()},this.getNotification=function(t,e){return self.registration.pushManager.getSubscription().then(function(t){return this.setSubscriptionId(t)}.bind(this)).then(function(){return this.setPartnerName(t)}.bind(this)).then(function(){return this.fetchNotification(e)}.bind(this)).then(function(t){return t})},this.setPartnerName=function(t){partnerName=void 0!==t.partnerName?t.partnerName:this.getPartnerName()},this.getPartnerName=function(){return!1!==partnerName?partnerName:self.registration.scope.split(".")[0].split("//")[1]},this.showErrorNotification=function(){var t={body:"Sorry, the content wasn't delivered appropriately.",icon:"https://"+this.getPartnerName()+".api.useinsider.com/views/push/img/notification_error.png",tag:"insider-notification-error"};return self.registration.showNotification("Oops! Something went wrong.",t)},this.displayNotification=function(t){return t?Promise.all(t.map(function(t){try{return self.registration.showNotification(t.title,t.options).then(function(){-1!==t.options.body.indexOf("web-push-automation")&&this.putLastPushDataToDB(t),this.feedJourneyAPI([Object.assign({actionCode:NOTIFICATION_DELIVER_ACTION_CODE},this.getJourneyAPIDefaultParameters(t.options.data.url))])}.bind(this))}catch(t){return this.showErrorNotification()}}.bind(this))):Promise.resolve()},this.feedJourneyAPI=function(t){t[0].journeyId&&fetch(COLLECTOR_API_ENDPOINT,{method:"POST",mode:"no-cors",body:JSON.stringify(t)})},this.sendLog=function(t){var e=LOG_API_ENDPOINT+"?pn="+this.getPartnerName()+"&t=w&p="+t;fetch(e,{mode:"no-cors"})},this.getWebPushLogParameters=function(){return{type:"webPush",table:"webPushLogs",isMobile:this.isMobile(),browser:this.getBrowser(),userId:this.spUID}},this.getWebPushClickLogParameters=function(t){var e=Object.assign({campId:t.notification.tag,primaryAction:"insider-primary-action"===t.action,secondaryAction:"insider-secondary-action"===t.action,logType:"camp-join"},this.getWebPushLogParameters());return encodeURIComponent(JSON.stringify(e))},this.getWebPushCloseLogParameters=function(t){var e=Object.assign({campId:t.notification.tag,logType:"web-push-close-notification"},this.getWebPushLogParameters());return encodeURIComponent(JSON.stringify(e))},this.getWebPushImpressionLogParameters=function(t){var e=Object.assign({campId:t.campId,logType:"web-push-impression"},this.getWebPushLogParameters());return encodeURIComponent(JSON.stringify(e))},this.notificationClickListener=function(t){this.sendLog(this.getWebPushClickLogParameters(t)),t.waitUntil(this.notificationClickHandler(t))},this.isValidUrl=function(t){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(t)},this.getParameterFromUrl=function(t,e){var i=new RegExp("[\\?&#]"+e+"=([^&#]*)").exec(t);return null===i?"":decodeURIComponent(i[1])},this.openNotification=function(t){return self.clients.matchAll({type:"window"}).then(function(){if(self.clients.openWindow&&this.isValidUrl(t))return self.clients.openWindow(t)}.bind(this))},this.getCurrentTimeAsFormatted=function(){var t=new Date;return t.toISOString().slice(0,10)+" "+t.toLocaleTimeString([],{hour12:!1})},this.getJourneyAPIDefaultParameters=function(t){return{partnerName:this.getPartnerName(),userId:this.spUID,journeyId:this.getParameterFromUrl(t,"journeyId"),campaignId:atob(this.getParameterFromUrl(t,"webPushId")),eventCode:this.getParameterFromUrl(t,"pushCode"),currentState:this.getParameterFromUrl(t,"currentState"),date:this.getCurrentTimeAsFormatted()}},this.notificationClickHandler=function(t){this.feedJourneyAPI([Object.assign({actionCode:NOTIFICATION_CLICK_ACTION_CODE},this.getJourneyAPIDefaultParameters(t.notification.data.url))]),t.notification.close();var e=t.notification.data.url;"insider-primary-action"===t.action&&(e=t.notification.data.actions[0].url),"insider-secondary-action"===t.action&&(e=t.notification.data.actions[1].url),t.waitUntil(Promise.all([this.openNotification(e)]))},this.notificationCloseHandler=function(t){this.feedJourneyAPI([Object.assign({actionCode:NOTIFICATION_CLOSE_ACTION_CODE},this.getJourneyAPIDefaultParameters(t.notification.data.url))]),this.sendLog(this.getWebPushCloseLogParameters(t))},this.openIndexedDB=function(t){return new Promise(function(e,i){if(DB)e(DB);else{var n=self.indexedDB.open(t);n.onsuccess=function(t){(DB=t.target.result).onversionchange=function(){DB.close(),DB=null},e(DB)},n.onerror=n.onblocked=i}})},this.getSettings=function(t){return new Promise(function(e,i){var n={};if(t.objectStoreNames.contains("settings")){var s=t.transaction("settings").objectStore("settings").openCursor();s.onsuccess=function(t){var i=t.target.result;i?(n[i.value.name]=i.value.value,i.continue()):e(n)},s.onerror=i}else n.partnerName=this.getPartnerName(),e(n)}.bind(this))},this.updateSettingsByName=function(t,e,i){t.transaction("settings","readwrite").objectStore("settings").openCursor().onsuccess=function(t){var n=t.target.result;if(n){if(n.value.name===e){const t=n.value;return t.value.push(i),n.update(t),!0}n.continue()}return!1}},this.getBrowser=function(){var t=navigator.userAgent,e=[],i=t.match(/(yabrowser|opera|chrome|firefox|edge|ubrowser(?=\/))\/?\s*(\d+)/i)||[];return this.name=i[1],this.version=i[2],"Chrome"===i[1]?this.isAgentMatches("Edge")?(e=this.getMatch("Edge"),this.name="Edge",this.version=e[2]):this.isAgentMatches("YaBrowser")?(e=this.getMatch("YaBrowser"),this.name="Yandex",this.version=e[2]):this.isAgentMatches("OPR")?(e=this.getMatch("OPR"),this.name="Opera",this.version=e[2]):this.isAgentMatches("SamsungBrowser")&&(e=this.getMatch("SamsungBrowser"),this.name="Samsung Internet",this.version=e[2]):i[1]&&"Chrome"!==i[1]?(e=/version\/(\d+)/i.exec(t),this.isAgentMatches("Firefox")&&(e=this.getMatch("Firefox"),this.name="Firefox",this.version=e[2]),null!==e&&(this.version=e[1])):(this.name="",this.version=-1),(this.isAgentMatches("coc_coc_browser")||navigator.vendor&&"Coc Coc"===navigator.vendor)&&(e=this._getMatch("coc_coc_browser"),this.name="CocCoc",this.version=e[2]),this.name},this.getMatch=function(t){return navigator.userAgent.match(new RegExp("\\b("+t+")/(\\d+)"))},this.isAgentMatches=function(t){return null!==this.getMatch(t)},this.isMobile=function(){return/android|opera mini|opera mobi|maemo|windows phone|fennec/i.test(navigator.userAgent)},t.initialize()}self.addEventListener("message",function(t){switch(t.data.command){case WorkerMessengerCommand.AMP_SUBSCRIPTION_STATE:onMessageReceivedSubscriptionState();break;case WorkerMessengerCommand.AMP_SUBSCRIBE:onMessageReceivedSubscribe();break;case WorkerMessengerCommand.AMP_UNSUBSCRIBE:onMessageReceivedUnsubscribe()}});var WorkerInstance=new PushWorker;